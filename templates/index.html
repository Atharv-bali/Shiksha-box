<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="container py-4">
    <h1 class="text-center mb-4">üë©‚Äçüè´ Teacher Dashboard</h1>
    <button class="btn btn-success mb-3" onclick="createContainer()">+ Create Student Container</button>

    <table class="table table-bordered text-center">
        <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Image</th>
                <th>Status</th>
                <th>CPU%</th>
                <th>Memory (MB)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="containerTable"></tbody>
    </table>

    <script>
        async function fetchContainers() {
            try {
                const res = await axios.get('/containers');
                const containers = res.data;
                const tbody = document.getElementById('containerTable');

                // --- Update container rows dynamically ---
                containers.forEach(c => {
                    const existingRow = document.getElementById(`row_${c.id}`);
                    if (!existingRow) {
                        // Add new row if it doesn't exist
                        tbody.insertAdjacentHTML('beforeend', `
                        <tr id="row_${c.id}">
                            <td>${c.id}</td>
                            <td>${c.name}</td>
                            <td>${c.image}</td>
                            <td>${c.status}</td>
                            <td id="cpu_${c.id}">‚Äî</td>
                            <td id="mem_${c.id}">‚Äî</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="stopContainer('${c.id}')">‚è∏ Stop</button>
                                <button class="btn btn-success btn-sm" onclick="restartContainer('${c.id}')">üîÑ Restart</button>
                                <button class="btn btn-danger btn-sm" onclick="removeContainer('${c.id}')">üóë Remove</button>
                            </td>
                        </tr>
                    `);
                    }
                });

                // --- Remove rows for containers that no longer exist ---
                const existingRows = Array.from(document.querySelectorAll("tbody tr"));
                existingRows.forEach(row => {
                    const id = row.id.replace("row_", "");
                    if (!containers.find(c => c.id === id)) {
                        row.remove();
                    }
                });
            } catch (err) {
                console.error("Error fetching containers:", err);
            }
        }

        // --- New function: update CPU and Memory live ---
        // --- New function: update CPU and Memory live ---
        async function updateStats() {
            const rows = document.querySelectorAll("tbody tr");
            if (rows.length === 0) return; // no containers yet

            for (const row of rows) {
                const id = row.id.replace("row_", "");
                try {
                    const res = await axios.get(`/container_stats/${id}`);
                    const data = res.data;
                    if (data && data.success !== false) {
                        const cpuCell = document.getElementById(`cpu_${id}`);
                        const memCell = document.getElementById(`mem_${id}`);
                        if (cpuCell) cpuCell.textContent = (data.cpu || 0) + '%';
                        if (memCell) memCell.textContent = (data.memory || 0);
                    }
                } catch (err) {
                    console.warn(`Error fetching stats for ${id}:`, err.message);
                }
            }
        }


        async function createContainer() {
            const res = await axios.post('/start_container', {});
            if (res.data.success) {
                alert(`‚úÖ Student container ${res.data.name} created!\nURL: ${res.data.url}`);
            } else {
                alert('‚ùå Error: ' + res.data.error);
            }
            fetchContainers();
        }

        async function stopContainer(id) {
            await axios.post('/stop_container/' + id);
            fetchContainers();
        }

        async function removeContainer(id) {
            await axios.delete('/remove_container/' + id);
            fetchContainers();
        }

        async function restartContainer(id) {
            try {
                const res = await axios.post('/restart_container/' + id);
                if (res.data.success) {
                    alert('‚úÖ ' + res.data.message);
                } else {
                    alert('‚ùå ' + res.data.error);
                }
            } catch (err) {
                alert('‚ùå Error restarting container');
            }
            fetchContainers();
        }

        // --- Refresh rules ---
        setInterval(fetchContainers, 5000); // updates container list (new/removals)
        setInterval(updateStats, 2000);     // refresh CPU & Memory frequently

        fetchContainers();
        updateStats();
    </script>

</body>

</html>